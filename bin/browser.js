!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NoLagJS={})}(this,(function(e){"use strict";var t,n;!function(e){e[e.InitConnection=1]="InitConnection",e[e.Authenticate=15]="Authenticate",e[e.Acknowledge=6]="Acknowledge",e[e.Reconnect=22]="Reconnect",e[e.Topic=26]="Topic",e[e.Identifier=11]="Identifier",e[e.Error=21]="Error",e[e.Alert=7]="Alert",e[e.AddAction=12]="AddAction",e[e.DeleteAction=16]="DeleteAction",e[e.Server=24]="Server",e[e.Payload=29]="Payload",e[e.Presence=14]="Presence"}(t||(t={})),function(e){e[e.ArraySeparator=31]="ArraySeparator"}(n||(n={}));class i{commandArray=[];setCommand(e,t){if(!e)return this;this.commandArray.push(e);let n=[];return t?(Array.isArray(t)?n=this.convertArray(t):"string"==typeof t&&(n=this.convertStringNumberArray(t)),this.commandArray=[...this.commandArray,...n],this):this}convertStringNumberArray(e){const t=(e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t),i=e.length+1;for(let t=0;t<i;t++)n[t]=e.charCodeAt(t);return t})(e);return Array.from(new Uint8Array(t))}convertArray(e){return e.map((e=>this.convertStringNumberArray(e))).map((e=>(e.push(n.ArraySeparator),e))).flat()}build(){return new Uint8Array(this.commandArray)}}const s=()=>new i;class o{static encode(e,n){const i=new Uint8Array(1);i[0]=t.Payload;const s=e.build(),o=s.byteLength;let c,r=0,a=new Uint8Array(0);n&&(r=n.byteLength+1,a=new Uint8Array(n),c=o+1);const h=new ArrayBuffer(o+r);let l=new Uint8Array(h);return l.set(s,0),n&&(l.set(i,o),l.set(a,c)),l.buffer}static decode(e){const n=e.byteLength,i=new Uint8Array(e);let s=i.indexOf(t.Payload);s=s<0?n:s;const o=i.slice(0,s),c=s+1,r=this.extractCommands(o);return{commands:r,payload:e.slice(c,n),getCommand:e=>!!r[e]&&r[e]}}static hasSeparatorIndexes(e){return e.indexOf(n.ArraySeparator)>0}static commandActionUint8ArrayToString(e){return e.map((e=>String.fromCharCode(e))).join("")}static commandActionUint8ArrayToStringArray(e){const t=[];let i=[];return e.forEach((e=>{e===n.ArraySeparator?(t.push(i),i=[]):i.push(e)})),i.length>0&&t.push(i),t.map((e=>this.commandActionUint8ArrayToString(e.map((e=>Number(e))))))}static extractCommands(e){const n={};let i=null;return e.forEach((e=>{if(Object.values(t).indexOf(e)>=0)return i=e,void(n[i]=[]);n[i].push(e)})),Object.keys(n).forEach((e=>{const t=n[e];this.hasSeparatorIndexes(t)?n[e]=this.commandActionUint8ArrayToStringArray(t):0===t.length?n[e]=!0:n[e]=this.commandActionUint8ArrayToString(t)})),n}}class c{connection;topicName;onReceiveCallback;identifiers=[];presence;constructor(e,t,n){this.setConnection(e),this.topicName=t,this.saveIdentifiers(n?.OR??[]),this.subscribe()}findSavedIdentifier(e){const t=Object.keys(e)[0]??"",n=Object.values(e)[0]??"";return this.identifiers.find((e=>{if(e){const i=Object.keys(e)[0]??"",s=Object.values(e)[0]??"";return t===i&&n===s}}))}saveIdentifiers(e){Array.isArray(e)&&e.map((e=>{this.identifiers.find((t=>t===e))||this.identifiers.push(e)}))}deleteSavedIdentifiers(e){const t=[];e.map((e=>{this.identifiers.find((t=>t===e))&&t.push(e)})),this.identifiers=t}subscribe(){if(!this.topicName&&0===this.identifiers?.length||!Array.isArray(this.identifiers))return this;const e=s().setCommand(t.Topic,this.topicName);this.identifiers.length>0&&e.setCommand(t.Identifier,this.identifiers),this.presence&&e.setCommand(t.Presence,this.presence),e.setCommand(t.AddAction);const n=o.encode(e);this.send(n)}setPresence(e){return this.presence=e,this.subscribe(),this}setConnection(e){return this.connection=e,this}_onReceiveMessage(e){return this.onReceiveCallback&&this.onReceiveCallback(e),this}onReceive(e){return this.onReceiveCallback=e,this}addIdentifiers(e){if(!e?.OR?.length||0===e?.OR?.length)return this;const n=e?.OR??[];this.saveIdentifiers(n);const i=s().setCommand(t.Topic,this.topicName);n.length>0&&i.setCommand(t.Identifier,n),i.setCommand(t.AddAction);const c=o.encode(i);return this.send(c),this}removeIdentifiers(e){if(0===e.length)return this;this.deleteSavedIdentifiers(e??[]);const n=s().setCommand(t.Topic,this.topicName);n.setCommand(t.Identifier,e),n.setCommand(t.DeleteAction);const i=o.encode(n);return this.send(i),this}unsubscribe(){const e=s().setCommand(t.Topic,this.topicName).setCommand(t.DeleteAction),n=o.encode(e);return this.send(n),!0}publish(e,n){if(0===e.byteLength)return this;const i=s().setCommand(t.Topic,this.topicName);n?.length>0&&i.setCommand(t.Identifier,n);const c=o.encode(i,e);return this.send(c),this}send(e){this.connection&&this.connection.send(e)}}var r,a,h,l,d,u,b,f,m;!function(e){e.Idle="idle",e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected"}(r||(r={})),function(e){e.Nodejs="nodejs",e.Browser="browser"}(a||(a={})),function(e){e.Add="a",e.Delete="d"}(h||(h={})),function(e){e.Arraybuffer="arraybuffer"}(l||(l={})),function(e){e.Hidden="hidden",e.Visible="visible"}(d||(d={})),function(e){e[e.Group=29]="Group",e[e.Record=30]="Record",e[e.Unit=31]="Unit",e[e.Vertical=11]="Vertical",e[e.NegativeAck=21]="NegativeAck",e[e.BellAlert=7]="BellAlert",e[e.SynchronousIdle=22]="SynchronousIdle"}(u||(u={})),function(e){e.Subscribe="subscribe",e.Publish="publish",e.PubSub="pubSub"}(b||(b={})),function(e){e.Active="active",e.Inactive="inactive"}(f||(f={})),function(e){e.Standard="standard",e.Api="api"}(m||(m={}));const C="tunnel.nolag.app",p="/ws",v="wss";class g{host;authToken;wsInstance;protocol;url;deviceConnectionId=void 0;environment;deviceTokenId=null;defaultCheckConnectionInterval=100;defaultCheckConnectionTimeout=1e4;checkConnectionInterval;checkConnectionTimeout;reConnect=!1;callbackOnOpen=()=>{};callbackOnReceive=()=>{};callbackOnClose=()=>{};callbackOnError=()=>{};connectionStatus=r.Idle;buffer=[];backpressureSendInterval=0;senderInterval=0;unifiedWebsocket;constructor(e,t,n){this.authToken=t??"",this.host=n?.host??C,this.protocol=n?.protocol??v,this.url=p,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.checkConnectionTimeout=n?.checkConnectionTimeout??this.defaultCheckConnectionTimeout,this.unifiedWebsocket=e,this.startSender()}startSender(){this.senderInterval=setInterval((()=>{const e=this.buffer.shift();e&&this.wsInstance&&this.wsInstance.send&&this.wsInstance.send(e)}),this.backpressureSendInterval)}slowDownSender(e){clearInterval(this.senderInterval),this.backpressureSendInterval=e,this.startSender()}addToBuffer(e){this.buffer.push(e)}setReConnect(e){e&&(this.reConnect=e)}connect(){return this.connectionStatus=r.Idle,this.initWebsocketConnection(),new Promise(((e,t)=>{const n=setInterval((()=>{this.connectionStatus===r.Connected&&(e(this),clearInterval(n))}),this.checkConnectionInterval);setTimeout((()=>{this.connectionStatus===r.Idle&&(t(!0),clearInterval(n))}),this.checkConnectionTimeout)}))}disconnect(){this.wsInstance&&this.wsInstance.close&&(this.wsInstance.close(),this.wsInstance=void 0)}initWebsocketConnection(){this.connectionStatus!==r.Connected&&(this.wsInstance=this.unifiedWebsocket(`${this.protocol}://${this.host}${this.url}`),this.wsInstance&&(this.wsInstance.onOpen&&this.wsInstance.onOpen((e=>{this._onOpen(e)})),this.wsInstance.onMessage&&this.wsInstance.onMessage((e=>{this._onReceive(e)})),this.wsInstance.onClose&&this.wsInstance.onClose((e=>{this._onClose(e)})),this.wsInstance.onError&&this.wsInstance.onError((e=>{this._onError(e)}))))}authenticate(){this.connectionStatus=r.Connecting;const{authToken:e}=this,n=s().setCommand(t.Authenticate,e);this.reConnect&&n.setCommand(t.Reconnect),this.send(o.encode(n))}onOpen(e){this.callbackOnOpen=e}onReceiveMessage(e){this.callbackOnReceive=e}onClose(e){this.callbackOnClose=e}onError(e){this.callbackOnError=e}_onOpen(e){this.connectionStatus,r.Idle,this.callbackOnOpen(void 0,e)}async _onReceive(e){const n=e??new ArrayBuffer(0),i=o.decode(n);if(0!==n.byteLength){if(!i.getCommand(t.InitConnection)||this.connectionStatus!==r.Idle)return i.getCommand(t.Acknowledge)&&this.connectionStatus===r.Connecting?(this.connectionStatus=r.Connected,void(this.deviceTokenId=i.getCommand(t.Acknowledge))):i.getCommand(t.Error)?(this.connectionStatus=r.Disconnected,void this.callbackOnError(i.getCommand(t.Alert),void 0)):void this.callbackOnReceive(void 0,{topicName:i.getCommand(t.Topic),presences:i.getCommand(t.Presence),identifiers:i.getCommand(t.Identifier),data:i.payload});this.authenticate()}}_onClose(e){this.connectionStatus=r.Disconnected,this.callbackOnClose(e,void 0)}_onError(e){this.connectionStatus=r.Disconnected,this.callbackOnError(e,void 0)}send(e){this.addToBuffer(e)}heartbeat(){this.wsInstance&&this.send(new ArrayBuffer(0))}}class y{noLagClient;connectOptions;authToken;topics={};heartbeatTimer;defaultCheckConnectionInterval=1e4;checkConnectionInterval;heartBeatInterval=2e4;visibilityState=d.Visible;callbackOnReceive;callbackOnDisconnect=()=>{};callbackOnReconnect=()=>{};callbackOnReceivedError=()=>{};constructor(e,t,n,i){this.checkConnectionInterval=i?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.connectOptions=i??void 0,this.authToken=t,this.noLagClient=new g(e,this.authToken,this.connectOptions),this.onClose(),this.onError(),this.onReceiveMessage(),n?.disconnectOnNoVisibility&&this.onVisibilityChange()}get deviceTokenId(){return this.noLagClient?.deviceTokenId}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.noLagClient&&this.noLagClient.heartbeat()}),this.heartBeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer)}async initiate(e){return this.noLagClient&&(this.noLagClient.setReConnect(e),await this.noLagClient.connect(),this.startHeartbeat()),this}onVisibilityChange(){document.addEventListener&&document.addEventListener("visibilitychange",(async()=>{switch(this.visibilityState=document.visibilityState,this.visibilityState){case d.Hidden:this.noLagClient?.disconnect(),this.stopHeartbeat();break;case d.Visible:await this.initiate(!0)}}))}onReceiveMessage(){this.noLagClient&&this.noLagClient?.onReceiveMessage(((e,t)=>{const{topicName:n,identifiers:i}=t;this.noLagClient&&!this.topics[n]&&(this.topics[n]=new c(this.noLagClient,n,{OR:i})),n&&this.topics[n]&&this.topics[n]?._onReceiveMessage(t),"function"==typeof this.callbackOnReceive&&this.callbackOnReceive(t)}))}reconnect(){this.stopHeartbeat(),setTimeout((async()=>{await this.initiate(!0),"function"==typeof this.callbackOnReconnect&&this.callbackOnReconnect()}),this.checkConnectionInterval)}canReconnect(){return this.visibilityState!==d.Hidden}doReconnect(){this.canReconnect()?this.reconnect():(this.stopHeartbeat(),"function"==typeof this.callbackOnDisconnect&&this.callbackOnDisconnect("connection retry timeout."))}onClose(){this.noLagClient&&this.noLagClient.onClose(((e,t)=>{this.doReconnect(),"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onError(){this.noLagClient&&this.noLagClient.onError(((e,t)=>{"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onReceive(e){this.callbackOnReceive=e}disconnect(){this.visibilityState=d.Hidden,this.noLagClient?.disconnect()}onDisconnect(e){this.callbackOnDisconnect=e}onReconnect(e){this.callbackOnReconnect=e}onErrors(e){this.callbackOnReceivedError=e}getTopic(e){return!this.topics[e]&&this.noLagClient&&(this.topics[e]=new c(this.noLagClient,e,{})),this.topics[e]}unsubscribe(e){return!!this.topics[e]&&(this.topics[e]?.unsubscribe(),delete this.topics[e],!0)}subscribe(e,t={}){if(this.noLagClient)return this.topics[e]||(this.topics[e]=new c(this.noLagClient,e,t)),this.topics[e]}publish(e,n,i=[]){if(this.noLagClient&&this.noLagClient.send){this.stopHeartbeat();const c=s().setCommand(t.Topic,e);i?.length>0&&c.setCommand(t.Identifier,i);const r=o.encode(c,n);this.noLagClient.send(r),this.startHeartbeat()}}get status(){return this.noLagClient?.connectionStatus??null}}function k(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var I,A;var O=k(A?I:(A=1,I=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}));const w=e=>{const t={},n=new O(e);return n.binaryType=l.Arraybuffer,n.onopen=e=>{t?.onOpen&&t.onOpen(e)},n.onclose=e=>{t?.onClose&&t.onClose(e)},n.onerror=e=>{t?.onError&&t.onError(e)},n.onmessage=e=>{t?.onMessage&&t.onMessage(e.data)},t};e.WebSocketClient=async(e,t,n)=>new y(w,e,t,n).initiate()}));
//# sourceMappingURL=browser.js.map
