var e,t;!function(e){e[e.InitConnection=1]="InitConnection",e[e.Authenticate=15]="Authenticate",e[e.Acknowledge=6]="Acknowledge",e[e.Reconnect=22]="Reconnect",e[e.Topic=26]="Topic",e[e.Identifier=11]="Identifier",e[e.Error=21]="Error",e[e.Alert=7]="Alert",e[e.AddAction=12]="AddAction",e[e.DeleteAction=16]="DeleteAction",e[e.Server=24]="Server",e[e.Payload=29]="Payload",e[e.Presence=14]="Presence"}(e||(e={})),function(e){e[e.ArraySeparator=31]="ArraySeparator"}(t||(t={}));const n=e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t),s=e.length+1;for(let t=0;t<s;t++)n[t]=e.charCodeAt(t);return t},s=e=>n(e),i=e=>a(e),a=e=>new Uint8Array(e).reduce(((e,t)=>e+String.fromCharCode(t)),"");class o{commandArray=[];setCommand(e,t){if(!e)return this;this.commandArray.push(e);let n=[];return t?(Array.isArray(t)?n=this.convertArray(t):"string"==typeof t&&(n=this.convertStringNumberArray(t)),this.commandArray=[...this.commandArray,...n],this):this}convertStringNumberArray(e){const t=s(e);return Array.from(new Uint8Array(t))}convertArray(e){return e.map((e=>this.convertStringNumberArray(e))).map((e=>(e.push(t.ArraySeparator),e))).flat()}build(){return new Uint8Array(this.commandArray)}}const r=()=>new o;class c{static encode(t,n){const s=new Uint8Array(1);s[0]=e.Payload;const i=t.build(),a=i.byteLength;let o,r=0,c=new Uint8Array(0);n&&(r=n.byteLength+1,c=new Uint8Array(n),o=a+1);const h=new ArrayBuffer(a+r),u=new Uint8Array(h);return u.set(i,0),n&&(u.set(s,a),u.set(c,o)),u.buffer}static decode(t){const n=t.byteLength,s=new Uint8Array(t);let i=s.indexOf(e.Payload);i=i<0?n:i;const a=s.slice(0,i),o=i+1,r=this.extractCommands(a);return{commands:r,payload:t.slice(o,n),getCommand:e=>!!r[e]&&r[e]}}static hasSeparatorIndexes(e){return e.indexOf(t.ArraySeparator)>0}static commandActionUint8ArrayToString(e){return e.map((e=>String.fromCharCode(e))).join("")}static commandActionUint8ArrayToStringArray(e){const n=[];let s=[];return e.forEach((e=>{e===t.ArraySeparator?(n.push(s),s=[]):s.push(e)})),s.length>0&&n.push(s),n.map((e=>this.commandActionUint8ArrayToString(e.map((e=>Number(e))))))}static extractCommands(t){const n={};let s=null;return t.forEach((t=>{if(Object.values(e).indexOf(t)>=0)return s=t,void(n[s]=[]);n[s].push(t)})),Object.keys(n).forEach((e=>{const t=n[e];this.hasSeparatorIndexes(t)?n[e]=this.commandActionUint8ArrayToStringArray(t):0===t.length?n[e]=!0:n[e]=this.commandActionUint8ArrayToString(t)})),n}}class h{connection;topicName;onReceiveCallback;identifiers=[];presence;constructor(e,t,n){this.setConnection(e),this.topicName=t,this.saveIdentifiers(n?.OR??[]),this.subscribe()}findSavedIdentifier(e){const t=Object.keys(e)[0]??"",n=Object.values(e)[0]??"";return this.identifiers.find((e=>{if(e){const s=Object.keys(e)[0]??"",i=Object.values(e)[0]??"";return t===s&&n===i}}))}saveIdentifiers(e){Array.isArray(e)&&e.map((e=>{this.identifiers.find((t=>t===e))||this.identifiers.push(e)}))}deleteSavedIdentifiers(e){const t=[];e.map((e=>{this.identifiers.find((t=>t===e))&&t.push(e)})),this.identifiers=t}subscribe(){if(!this.topicName&&0===this.identifiers?.length||!Array.isArray(this.identifiers))return this;const t=r().setCommand(e.Topic,this.topicName);this.identifiers.length>0&&t.setCommand(e.Identifier,this.identifiers),this.presence&&t.setCommand(e.Presence,this.presence),t.setCommand(e.AddAction);const n=c.encode(t);this.send(n)}setPresence(e){return this.presence=e,this.subscribe(),this}setConnection(e){return this.connection=e,this}_onReceiveMessage(e){return this.onReceiveCallback&&this.onReceiveCallback(e),this}onReceive(e){return this.onReceiveCallback=e,this}addIdentifiers(t){if(!t?.OR?.length||0===t?.OR?.length)return this;const n=t?.OR??[];this.saveIdentifiers(n);const s=r().setCommand(e.Topic,this.topicName);n.length>0&&s.setCommand(e.Identifier,n),s.setCommand(e.AddAction);const i=c.encode(s);return this.send(i),this}removeIdentifiers(t){if(0===t.length)return this;this.deleteSavedIdentifiers(t??[]);const n=r().setCommand(e.Topic,this.topicName);n.setCommand(e.Identifier,t),n.setCommand(e.DeleteAction);const s=c.encode(n);return this.send(s),this}unsubscribe(){const t=r().setCommand(e.Topic,this.topicName).setCommand(e.DeleteAction),n=c.encode(t);return this.send(n),!0}publish(t,n){if(0===t.byteLength)return this;const s=r().setCommand(e.Topic,this.topicName);n?.length>0&&s.setCommand(e.Identifier,n);const i=c.encode(s,t);return this.send(i),this}send(e){this.connection&&this.connection.send(e)}}var u,d,l,m,p,f,b,C;!function(e){e.Idle="idle",e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected"}(u||(u={})),function(e){e.Nodejs="nodejs",e.Browser="browser"}(d||(d={})),function(e){e.Arraybuffer="arraybuffer"}(l||(l={})),function(e){e.Hidden="hidden",e.Visible="visible"}(m||(m={})),function(e){e.Subscribe="subscribe",e.Publish="publish",e.PubSub="pubSub"}(p||(p={})),function(e){e.Active="active",e.Inactive="inactive"}(f||(f={})),function(e){e.Standard="standard",e.Api="api"}(b||(b={})),function(e){e.RoundRobbin="roundRobin"}(C||(C={}));const y={DefaultWsHost:"tunnel.nolag.app",DefaultApiHost:"api.nolag.app",DefaultWsUrl:"/ws",DefaultPort:443,DefaultWsProtocol:"wss",DefaultApiUrl:"/v1",DefaultHttpProtocol:"https"};class v{host;authToken;wsInstance;protocol;url;deviceConnectionId=void 0;environment;deviceTokenId=null;defaultCheckConnectionInterval=100;defaultCheckConnectionTimeout=1e4;checkConnectionInterval;checkConnectionTimeout;reConnect=!1;callbackOnOpen=()=>{};callbackOnReceive=()=>{};callbackOnClose=()=>{};callbackOnError=()=>{};connectionStatus=u.Idle;buffer=[];backpressureSendInterval=0;senderInterval=0;unifiedWebsocket;constructor(e,t,n){this.authToken=t??"",this.host=n?.host??y.DefaultWsHost,this.protocol=n?.protocol??y.DefaultWsProtocol,this.url=y.DefaultWsUrl,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.checkConnectionTimeout=n?.checkConnectionTimeout??this.defaultCheckConnectionTimeout,this.unifiedWebsocket=e,this.startSender()}startSender(){this.senderInterval=setInterval((()=>{const e=this.buffer.shift();e&&this.wsInstance&&this.wsInstance.send&&this.wsInstance.send(e)}),this.backpressureSendInterval)}slowDownSender(e){clearInterval(this.senderInterval),this.backpressureSendInterval=e,this.startSender()}addToBuffer(e){this.buffer.push(e)}setReConnect(e){e&&(this.reConnect=e)}connect(){return this.connectionStatus=u.Idle,this.initWebsocketConnection(),new Promise(((e,t)=>{const n=setInterval((()=>{this.connectionStatus===u.Connected&&(e(this),clearInterval(n))}),this.checkConnectionInterval);setTimeout((()=>{this.connectionStatus===u.Idle&&(t(!0),clearInterval(n))}),this.checkConnectionTimeout)}))}disconnect(){this.wsInstance&&this.wsInstance.close&&(this.wsInstance.close(),this.wsInstance=void 0)}initWebsocketConnection(){this.connectionStatus!==u.Connected&&(this.wsInstance=this.unifiedWebsocket(`${this.protocol}://${this.host}${this.url}`),this.wsInstance&&(this.wsInstance.onOpen=e=>{this._onOpen(e)},this.wsInstance.onMessage=e=>{this._onReceive(e)},this.wsInstance.onClose=e=>{this._onClose(e)},this.wsInstance.onError=e=>{this._onError(e)}))}authenticate(){this.connectionStatus=u.Connecting;const{authToken:t}=this,n=r().setCommand(e.Authenticate,t);this.reConnect&&n.setCommand(e.Reconnect),this.send(c.encode(n))}onOpen(e){this.callbackOnOpen=e}onReceiveMessage(e){this.callbackOnReceive=e}onClose(e){this.callbackOnClose=e}onError(e){this.callbackOnError=e}_onOpen(e){this.connectionStatus,u.Idle,this.callbackOnOpen(void 0,e)}_onReceive(t){const n=t??new ArrayBuffer(0),s=c.decode(n);if(0===n.byteLength)return;if(s.getCommand(e.InitConnection)&&this.connectionStatus===u.Idle)return void this.authenticate();if(s.getCommand(e.Acknowledge)&&this.connectionStatus===u.Connecting)return this.connectionStatus=u.Connected,void(this.deviceTokenId=s.getCommand(e.Acknowledge));if(s.getCommand(e.Error))return this.connectionStatus=u.Disconnected,void this.callbackOnError(s.getCommand(e.Alert),void 0);const i=s.getCommand(e.Identifier),a=s.getCommand(e.Presence);this.callbackOnReceive(void 0,{topicName:s.getCommand(e.Topic),presences:!0===a?[]:a,identifiers:!0===i?[]:i,data:s.payload})}_onClose(e){this.connectionStatus=u.Disconnected,this.callbackOnClose(e,void 0)}_onError(e){this.connectionStatus=u.Disconnected,this.callbackOnError(e,void 0)}send(e){this.addToBuffer(e)}heartbeat(){this.wsInstance&&this.send(new ArrayBuffer(0))}}class g{noLagClient;connectOptions;authToken;topics={};heartbeatTimer;defaultCheckConnectionInterval=1e4;checkConnectionInterval;heartBeatInterval=2e4;visibilityState=m.Visible;callbackOnReceive;callbackOnDisconnect=()=>{};callbackOnReconnect=()=>{};callbackOnReceivedError=()=>{};constructor(e,t,n,s){this.checkConnectionInterval=s?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.connectOptions=s??void 0,this.authToken=t,this.noLagClient=new v(e,this.authToken,this.connectOptions),this.onClose(),this.onError(),this.onReceiveMessage(),n?.disconnectOnNoVisibility&&this.onVisibilityChange()}get deviceTokenId(){return this.noLagClient?.deviceTokenId}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.noLagClient&&this.noLagClient.heartbeat()}),this.heartBeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer)}async initiate(e){return this.noLagClient&&(this.noLagClient.setReConnect(e),await this.noLagClient.connect(),this.startHeartbeat()),this}onVisibilityChange(){document.addEventListener&&document.addEventListener("visibilitychange",(async()=>{switch(this.visibilityState=document.visibilityState,this.visibilityState){case m.Hidden:this.noLagClient?.disconnect(),this.stopHeartbeat();break;case m.Visible:await this.initiate(!0)}}))}onReceiveMessage(){this.noLagClient&&this.noLagClient?.onReceiveMessage(((e,t)=>{const{topicName:n,identifiers:s}=t;this.noLagClient&&!this.topics[n]&&(this.topics[n]=new h(this.noLagClient,n,{OR:s})),n&&this.topics[n]&&this.topics[n]?._onReceiveMessage(t),"function"==typeof this.callbackOnReceive&&this.callbackOnReceive(t)}))}reconnect(){this.stopHeartbeat(),setTimeout((async()=>{await this.initiate(!0),"function"==typeof this.callbackOnReconnect&&this.callbackOnReconnect()}),this.checkConnectionInterval)}canReconnect(){return this.visibilityState!==m.Hidden}doReconnect(){this.canReconnect()?this.reconnect():(this.stopHeartbeat(),"function"==typeof this.callbackOnDisconnect&&this.callbackOnDisconnect("connection retry timeout."))}onClose(){this.noLagClient&&this.noLagClient.onClose(((e,t)=>{this.doReconnect(),"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onError(){this.noLagClient&&this.noLagClient.onError(((e,t)=>{"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onReceive(e){this.callbackOnReceive=e}disconnect(){this.visibilityState=m.Hidden,this.noLagClient?.disconnect()}onDisconnect(e){this.callbackOnDisconnect=e}onReconnect(e){this.callbackOnReconnect=e}onErrors(e){this.callbackOnReceivedError=e}getTopic(e){return!this.topics[e]&&this.noLagClient&&(this.topics[e]=new h(this.noLagClient,e,{})),this.topics[e]}unsubscribe(e){return!!this.topics[e]&&(this.topics[e]?.unsubscribe(),delete this.topics[e],!0)}subscribe(e,t={}){if(this.noLagClient)return this.topics[e]||(this.topics[e]=new h(this.noLagClient,e,t)),this.topics[e]}publish(t,n,s=[]){if(this.noLagClient&&this.noLagClient.send){this.stopHeartbeat();const i=r().setCommand(e.Topic,t);s?.length>0&&i.setCommand(e.Identifier,s);const a=c.encode(i,n);this.noLagClient.send(a),this.startHeartbeat()}}get status(){return this.noLagClient?.connectionStatus??null}}const w=e=>{const t=new WebSocket(e);t.binaryType=l.Arraybuffer;const n={send:e=>{t.send(e)},close:()=>{t.close()}};return t.onopen=e=>{n?.onOpen&&n.onOpen(e)},t.onclose=e=>{n?.onClose&&n.onClose(e)},t.onerror=e=>{n?.onError&&n.onError(e)},t.onmessage=e=>{n?.onMessage&&n.onMessage(e.data)},n},I=e=>{if(!e)return"";const t=[],n=e;Object.keys(n).map((e=>{t.push(`${e}=${n[e]}`)}));const s=t.join("&");return s?`?${s}`:""};class A{routeNamespace="devices";parentRouteNamespace;tunnelId;requestParams;constructor(e,t,n){this.parentRouteNamespace=e,this.tunnelId=t,this.requestParams=n}async createDevice(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async getDeviceById(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"GET",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}async listDevices(e){const t=I(e),n=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${t}`,{method:"GET",headers:this.requestParams.headers});if(n.status>=400)throw await n.json();return n.json()}async updateDevice(e,t){const n=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(t)});if(n.status>=400)throw await n.json();return n.json()}async deleteDevice(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"DELETE",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}}const k=async(t,n,s,i,a,o,h)=>{const u=r().setCommand(e.Topic,n).setCommand(e.Identifier,s).setCommand(e.AddAction),d=c.encode(u,t),l=`${h?.protocol}://${h?.wsHost}`;return await fetch(`${l}/${a}/${i}/publish`,{headers:o.headers,method:"POST",body:d}),!0};class R{routeNamespace="topics";parentRouteNamespace;tunnelId;requestParams;constructor(e,t,n){this.parentRouteNamespace=e,this.tunnelId=t,this.requestParams=n}async createTopic(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async getTopicById(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"GET",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}async listTopics(e){const t=e?I(e):"",n=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${t}`,{method:"GET",headers:this.requestParams.headers});if(n.status>=400)throw await n.json();return n.json()}async updateTopic(e,t){const n=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(t)});if(n.status>=400)throw await n.json();return n.json()}async deleteTopic(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"DELETE",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}}class O{routeNamespace="tunnels";tunnelId;requestParams;apiTunnel;constructor(e,t,n){this.tunnelId=t,this.requestParams=n,this.apiTunnel=e}get topics(){return new R(this.routeNamespace,this.tunnelId,this.requestParams)}get devices(){return new A(this.routeNamespace,this.tunnelId,this.requestParams)}async getTunnel(){const e=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"GET",headers:this.requestParams.headers});if(e.status>=400)throw await e.json();return e.json()}async updateTunnel(e){const t=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async deleteTunnel(){const e=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"DELETE",headers:this.requestParams.headers});if(e.status>=400)throw await e.json();return e.json()}async publish(e){const{data:t,topicName:n,identifiers:s}=e;return k(t,n,s,this.tunnelId,this.routeNamespace,this.requestParams,this.apiTunnel.connectOptions)}}class ${apiKey;connectOptions;requestParams;constructor(e,t){this.connectOptions={host:y.DefaultApiHost,protocol:y.DefaultHttpProtocol,url:y.DefaultApiUrl,wsUrl:y.DefaultWsUrl,wsHost:y.DefaultWsHost,apiKey:e,...t},this.apiKey=e,this.requestParams={baseURL:`${this.connectOptions?.protocol}://${this.connectOptions?.host}${this.connectOptions?.url}`,headers:{"X-API-Key":this.apiKey,"Content-Type":"application/json"}}}async tunnels(e){const t=new URLSearchParams(e).toString();return(await fetch(`${this.requestParams.baseURL}/tunnels${t?`?${t}`:""}`,{headers:this.requestParams.headers,method:"get"})).json()}async createTunnel(e){const t=await fetch(`${this.requestParams.baseURL}/tunnels`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}tunnel(e){return new O(this,e,this.requestParams)}}const P=(e,t)=>new $(e,t);console.log("load browserInstance");const T=async(e,t,n)=>new g(w,e,t,n).initiate();export{P as Api,y as CONSTANT,p as EAccessPermission,u as EConnectionStatus,l as EEncoding,d as EEnvironment,C as ELoadBalanceType,f as EStatus,b as ETopicType,m as EVisibilityState,c as NqlTransport,h as Topic,g as Tunnel,O as TunnelApi,A as TunnelDevice,k as TunnelPublish,R as TunnelTopic,T as WebSocketClient,i as bufferToString,I as generateQueryString,n as stringToArrayBuffer,s as stringToBuffer,a as uint8ArrayToString};
//# sourceMappingURL=browserInstance.js.map
