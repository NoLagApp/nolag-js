const e=e=>{const t=[],n=e;Object.keys(n).map((e=>{t.push(`${e}=${n[e]}`)}));const i=t.join("&");return i?`?${i}`:""};class t{routeNamespace="devices";parentRouteNamespace;tunnelId;request;constructor(e,t,n){this.parentRouteNamespace=e,this.tunnelId=t,this.request=n}async createDevice(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,method:"post",data:e})).data}async getDeviceById(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"get"})).data}async listDevices(t){const n=e(t);return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${n}`,method:"get"})).data}async updateDevice(e,t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"patch",data:t})).data}async deleteDevice(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"delete"})).data}}var n,i;!function(e){e[e.InitConnection=1]="InitConnection",e[e.Authenticate=15]="Authenticate",e[e.Acknowledge=6]="Acknowledge",e[e.Reconnect=22]="Reconnect",e[e.Topic=26]="Topic",e[e.Identifier=11]="Identifier",e[e.Error=21]="Error",e[e.Alert=7]="Alert",e[e.AddAction=12]="AddAction",e[e.DeleteAction=16]="DeleteAction",e[e.Server=24]="Server",e[e.Payload=29]="Payload",e[e.Presence=14]="Presence"}(n||(n={})),function(e){e[e.ArraySeparator=31]="ArraySeparator"}(i||(i={}));const s=e=>{const t=new ArrayBuffer(e.length),n=new Uint8Array(t),i=e.length+1;for(let t=0;t<i;t++)n[t]=e.charCodeAt(t);return t},o=e=>new Uint8Array(e).reduce(((e,t)=>e+String.fromCharCode(t)),"");class c{commandArray=[];setCommand(e,t){if(!e)return this;this.commandArray.push(e);let n=[];return t?(Array.isArray(t)?n=this.convertArray(t):"string"==typeof t&&(n=this.convertStringNumberArray(t)),this.commandArray=[...this.commandArray,...n],this):this}convertStringNumberArray(e){const t=s(e);return Array.from(new Uint8Array(t))}convertArray(e){return e.map((e=>this.convertStringNumberArray(e))).map((e=>(e.push(i.ArraySeparator),e))).flat()}build(){return new Uint8Array(this.commandArray)}}const a=()=>new c;class r{static encode(e,t){const i=new Uint8Array(1);i[0]=n.Payload;const s=e.build(),o=s.byteLength;let c,a=0,r=new Uint8Array(0);t&&(a=t.byteLength+1,r=new Uint8Array(t),c=o+1);const h=new ArrayBuffer(o+a);let l=new Uint8Array(h);return l.set(s,0),t&&(l.set(i,o),l.set(r,c)),l.buffer}static decode(e){const t=e.byteLength,i=new Uint8Array(e);let s=i.indexOf(n.Payload);s=s<0?t:s;const o=i.slice(0,s),c=s+1,a=this.extractCommands(o);return{commands:a,payload:e.slice(c,t),getCommand:e=>!!a[e]&&a[e]}}static hasSeparatorIndexes(e){return e.indexOf(i.ArraySeparator)>0}static commandActionUint8ArrayToString(e){return e.map((e=>String.fromCharCode(e))).join("")}static commandActionUint8ArrayToStringArray(e){const t=[];let n=[];return e.forEach((e=>{e===i.ArraySeparator?(t.push(n),n=[]):n.push(e)})),n.length>0&&t.push(n),t.map((e=>this.commandActionUint8ArrayToString(e.map((e=>Number(e))))))}static extractCommands(e){const t={};let i=null;return e.forEach((e=>{if(Object.values(n).indexOf(e)>=0)return i=e,void(t[i]=[]);t[i].push(e)})),Object.keys(t).forEach((e=>{const n=t[e];this.hasSeparatorIndexes(n)?t[e]=this.commandActionUint8ArrayToStringArray(n):0===n.length?t[e]=!0:t[e]=this.commandActionUint8ArrayToString(n)})),t}}const h=async(e,t,i,s,o,c,h)=>{const l=a().setCommand(n.Topic,t).setCommand(n.Identifier,i).setCommand(n.AddAction),d=r.encode(l,e);return await c.request({baseURL:`${h?.protocol}://${h?.wsHost}`,headers:{"Content-Type":"application/json","X-API-Key":h?.apiKey},url:`/${o}/${s}/publish`,method:"post",data:d}),!0};class l{routeNamespace="Topics";parentRouteNamespace;tunnelId;request;constructor(e,t,n){this.parentRouteNamespace=e,this.tunnelId=t,this.request=n}async createTopic(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,method:"post",data:e})).data}async getTopicById(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"get"})).data}async listTopics(t){const n=t?e(t):"";return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${n}`,method:"get"})).data}async updateTopic(e,t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"patch",data:t})).data}async deleteTopic(e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,method:"delete"})).data}}class d{routeNamespace="tunnels";tunnelId;request;apiTunnel;constructor(e,t,n){this.tunnelId=t,this.request=n,this.apiTunnel=e}get topics(){return new l(this.routeNamespace,this.tunnelId,this.request)}get devices(){return new t(this.routeNamespace,this.tunnelId,this.request)}async publish(e){const{data:t,topicName:n,identifiers:i}=e;return h(t,n,i,this.tunnelId,this.routeNamespace,this.request,this.apiTunnel.connectOptions)}}class u{connection;topicName;onReceiveCallback;identifiers=[];presence;constructor(e,t,n){this.setConnection(e),this.topicName=t,this.saveIdentifiers(n?.OR??[]),this.subscribe()}findSavedIdentifier(e){const t=Object.keys(e)[0]??"",n=Object.values(e)[0]??"";return this.identifiers.find((e=>{if(e){const i=Object.keys(e)[0]??"",s=Object.values(e)[0]??"";return t===i&&n===s}}))}saveIdentifiers(e){Array.isArray(e)&&e.map((e=>{this.identifiers.find((t=>t===e))||this.identifiers.push(e)}))}deleteSavedIdentifiers(e){const t=[];e.map((e=>{this.identifiers.find((t=>t===e))&&t.push(e)})),this.identifiers=t}subscribe(){if(!this.topicName&&0===this.identifiers?.length||!Array.isArray(this.identifiers))return this;const e=a().setCommand(n.Topic,this.topicName);this.identifiers.length>0&&e.setCommand(n.Identifier,this.identifiers),this.presence&&e.setCommand(n.Presence,this.presence),e.setCommand(n.AddAction);const t=r.encode(e);this.send(t)}setPresence(e){return this.presence=e,this.subscribe(),this}setConnection(e){return this.connection=e,this}_onReceiveMessage(e){return this.onReceiveCallback&&this.onReceiveCallback(e),this}onReceive(e){return this.onReceiveCallback=e,this}addIdentifiers(e){if(!e?.OR?.length||0===e?.OR?.length)return this;const t=e?.OR??[];this.saveIdentifiers(t);const i=a().setCommand(n.Topic,this.topicName);t.length>0&&i.setCommand(n.Identifier,t),i.setCommand(n.AddAction);const s=r.encode(i);return this.send(s),this}removeIdentifiers(e){if(0===e.length)return this;this.deleteSavedIdentifiers(e??[]);const t=a().setCommand(n.Topic,this.topicName);t.setCommand(n.Identifier,e),t.setCommand(n.DeleteAction);const i=r.encode(t);return this.send(i),this}unsubscribe(){const e=a().setCommand(n.Topic,this.topicName).setCommand(n.DeleteAction),t=r.encode(e);return this.send(t),!0}publish(e,t){if(0===e.byteLength)return this;const i=a().setCommand(n.Topic,this.topicName);t?.length>0&&i.setCommand(n.Identifier,t);const s=r.encode(i,e);return this.send(s),this}send(e){this.connection&&this.connection.send(e)}}var p,m,b,C,f,v,I,y,g;!function(e){e.Idle="idle",e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected"}(p||(p={})),function(e){e.Nodejs="nodejs",e.Browser="browser"}(m||(m={})),function(e){e.Add="a",e.Delete="d"}(b||(b={})),function(e){e.Arraybuffer="arraybuffer"}(C||(C={})),function(e){e.Hidden="hidden",e.Visible="visible"}(f||(f={})),function(e){e[e.Group=29]="Group",e[e.Record=30]="Record",e[e.Unit=31]="Unit",e[e.Vertical=11]="Vertical",e[e.NegativeAck=21]="NegativeAck",e[e.BellAlert=7]="BellAlert",e[e.SynchronousIdle=22]="SynchronousIdle"}(v||(v={})),function(e){e.Subscribe="subscribe",e.Publish="publish",e.PubSub="pubSub"}(I||(I={})),function(e){e.Active="active",e.Inactive="inactive"}(y||(y={})),function(e){e.Standard="standard",e.Api="api"}(g||(g={}));const A={DefaultWsHost:"tunnel.nolag.app",DefaultApiHost:"api.nolag.app",DefaultWsUrl:"/ws",DefaultPort:443,DefaultWsProtocol:"wss",DefaultApiUrl:"/v1",DefaultHttpProtocol:"https"};class k{host;authToken;wsInstance;protocol;url;deviceConnectionId=void 0;environment;deviceTokenId=null;defaultCheckConnectionInterval=100;defaultCheckConnectionTimeout=1e4;checkConnectionInterval;checkConnectionTimeout;reConnect=!1;callbackOnOpen=()=>{};callbackOnReceive=()=>{};callbackOnClose=()=>{};callbackOnError=()=>{};connectionStatus=p.Idle;buffer=[];backpressureSendInterval=0;senderInterval=0;unifiedWebsocket;constructor(e,t,n){this.authToken=t??"",this.host=n?.host??A.DefaultWsHost,this.protocol=n?.protocol??A.DefaultWsProtocol,this.url=A.DefaultWsUrl,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.checkConnectionTimeout=n?.checkConnectionTimeout??this.defaultCheckConnectionTimeout,this.unifiedWebsocket=e,this.startSender()}startSender(){this.senderInterval=setInterval((()=>{const e=this.buffer.shift();e&&this.wsInstance&&this.wsInstance.send&&this.wsInstance.send(e)}),this.backpressureSendInterval)}slowDownSender(e){clearInterval(this.senderInterval),this.backpressureSendInterval=e,this.startSender()}addToBuffer(e){this.buffer.push(e)}setReConnect(e){e&&(this.reConnect=e)}connect(){return this.connectionStatus=p.Idle,this.initWebsocketConnection(),new Promise(((e,t)=>{const n=setInterval((()=>{this.connectionStatus===p.Connected&&(e(this),clearInterval(n))}),this.checkConnectionInterval);setTimeout((()=>{this.connectionStatus===p.Idle&&(t(!0),clearInterval(n))}),this.checkConnectionTimeout)}))}disconnect(){this.wsInstance&&this.wsInstance.close&&(this.wsInstance.close(),this.wsInstance=void 0)}initWebsocketConnection(){this.connectionStatus!==p.Connected&&(this.wsInstance=this.unifiedWebsocket(`${this.protocol}://${this.host}${this.url}`),this.wsInstance&&(this.wsInstance.onOpen=e=>{this._onOpen(e)},this.wsInstance.onMessage=e=>{this._onReceive(e)},this.wsInstance.onClose=e=>{this._onClose(e)},this.wsInstance.onError=e=>{this._onError(e)}))}authenticate(){this.connectionStatus=p.Connecting;const{authToken:e}=this,t=a().setCommand(n.Authenticate,e);this.reConnect&&t.setCommand(n.Reconnect),this.send(r.encode(t))}onOpen(e){this.callbackOnOpen=e}onReceiveMessage(e){this.callbackOnReceive=e}onClose(e){this.callbackOnClose=e}onError(e){this.callbackOnError=e}_onOpen(e){this.connectionStatus,p.Idle,this.callbackOnOpen(void 0,e)}_onReceive(e){const t=e??new ArrayBuffer(0),i=r.decode(t);if(0!==t.byteLength){if(!i.getCommand(n.InitConnection)||this.connectionStatus!==p.Idle)return i.getCommand(n.Acknowledge)&&this.connectionStatus===p.Connecting?(this.connectionStatus=p.Connected,void(this.deviceTokenId=i.getCommand(n.Acknowledge))):i.getCommand(n.Error)?(this.connectionStatus=p.Disconnected,void this.callbackOnError(i.getCommand(n.Alert),void 0)):void this.callbackOnReceive(void 0,{topicName:i.getCommand(n.Topic),presences:i.getCommand(n.Presence),identifiers:i.getCommand(n.Identifier),data:i.payload});this.authenticate()}}_onClose(e){this.connectionStatus=p.Disconnected,this.callbackOnClose(e,void 0)}_onError(e){this.connectionStatus=p.Disconnected,this.callbackOnError(e,void 0)}send(e){this.addToBuffer(e)}heartbeat(){this.wsInstance&&this.send(new ArrayBuffer(0))}}class w{noLagClient;connectOptions;authToken;topics={};heartbeatTimer;defaultCheckConnectionInterval=1e4;checkConnectionInterval;heartBeatInterval=2e4;visibilityState=f.Visible;callbackOnReceive;callbackOnDisconnect=()=>{};callbackOnReconnect=()=>{};callbackOnReceivedError=()=>{};constructor(e,t,n,i){this.checkConnectionInterval=i?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.connectOptions=i??void 0,this.authToken=t,this.noLagClient=new k(e,this.authToken,this.connectOptions),this.onClose(),this.onError(),this.onReceiveMessage(),n?.disconnectOnNoVisibility&&this.onVisibilityChange()}get deviceTokenId(){return this.noLagClient?.deviceTokenId}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.noLagClient&&this.noLagClient.heartbeat()}),this.heartBeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer)}async initiate(e){return this.noLagClient&&(this.noLagClient.setReConnect(e),await this.noLagClient.connect(),this.startHeartbeat()),this}onVisibilityChange(){document.addEventListener&&document.addEventListener("visibilitychange",(async()=>{switch(this.visibilityState=document.visibilityState,this.visibilityState){case f.Hidden:this.noLagClient?.disconnect(),this.stopHeartbeat();break;case f.Visible:await this.initiate(!0)}}))}onReceiveMessage(){this.noLagClient&&this.noLagClient?.onReceiveMessage(((e,t)=>{const{topicName:n,identifiers:i}=t;this.noLagClient&&!this.topics[n]&&(this.topics[n]=new u(this.noLagClient,n,{OR:i})),n&&this.topics[n]&&this.topics[n]?._onReceiveMessage(t),"function"==typeof this.callbackOnReceive&&this.callbackOnReceive(t)}))}reconnect(){this.stopHeartbeat(),setTimeout((async()=>{await this.initiate(!0),"function"==typeof this.callbackOnReconnect&&this.callbackOnReconnect()}),this.checkConnectionInterval)}canReconnect(){return this.visibilityState!==f.Hidden}doReconnect(){this.canReconnect()?this.reconnect():(this.stopHeartbeat(),"function"==typeof this.callbackOnDisconnect&&this.callbackOnDisconnect("connection retry timeout."))}onClose(){this.noLagClient&&this.noLagClient.onClose(((e,t)=>{this.doReconnect(),"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onError(){this.noLagClient&&this.noLagClient.onError(((e,t)=>{"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onReceive(e){this.callbackOnReceive=e}disconnect(){this.visibilityState=f.Hidden,this.noLagClient?.disconnect()}onDisconnect(e){this.callbackOnDisconnect=e}onReconnect(e){this.callbackOnReconnect=e}onErrors(e){this.callbackOnReceivedError=e}getTopic(e){return!this.topics[e]&&this.noLagClient&&(this.topics[e]=new u(this.noLagClient,e,{})),this.topics[e]}unsubscribe(e){return!!this.topics[e]&&(this.topics[e]?.unsubscribe(),delete this.topics[e],!0)}subscribe(e,t={}){if(this.noLagClient)return this.topics[e]||(this.topics[e]=new u(this.noLagClient,e,t)),this.topics[e]}publish(e,t,i=[]){if(this.noLagClient&&this.noLagClient.send){this.stopHeartbeat();const s=a().setCommand(n.Topic,e);i?.length>0&&s.setCommand(n.Identifier,i);const o=r.encode(s,t);this.noLagClient.send(o),this.startHeartbeat()}}get status(){return this.noLagClient?.connectionStatus??null}}"undefined"!=typeof process&&null!==process.versions&&process.versions.node,console.log(require("./browser"));const R="test";export{A as CONSTANT,I as EAccessPermission,b as EAction,p as EConnectionStatus,C as EEncoding,m as EEnvironment,v as ESeparator,y as EStatus,g as ETopicType,f as EVisibilityState,r as NqlTransport,u as Topic,w as Tunnel,d as TunnelApi,t as TunnelDevice,h as TunnelPublish,l as TunnelTopic,e as generateQueryString,s as stringToArrayBuffer,R as test,o as uint8ArrayToString};
//# sourceMappingURL=esm.js.map
