!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).NoLagJS={})}(this,(function(t){"use strict";const e=t=>{const e=[],n=t;Object.keys(n).map((t=>{e.push(`${t}=${n[t]}`)}));const i=e.join("&");return i?`?${i}`:""};class n{routeNamespace="devices";parentRouteNamespace;tunnelId;request;constructor(t,e,n){this.parentRouteNamespace=t,this.tunnelId=e,this.request=n}async createDevice(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,method:"post",data:t})).data}async getDeviceById(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"get"})).data}async listDevices(t){const n=e(t);return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${n}`,method:"get"})).data}async updateDevice(t,e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"patch",data:e})).data}async deleteDevice(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"delete"})).data}}var i,s;!function(t){t[t.InitConnection=1]="InitConnection",t[t.Authenticate=15]="Authenticate",t[t.Acknowledge=6]="Acknowledge",t[t.Reconnect=22]="Reconnect",t[t.Topic=26]="Topic",t[t.Identifier=11]="Identifier",t[t.Error=21]="Error",t[t.Alert=7]="Alert",t[t.AddAction=12]="AddAction",t[t.DeleteAction=16]="DeleteAction",t[t.Server=24]="Server",t[t.Payload=29]="Payload",t[t.Presence=14]="Presence"}(i||(i={})),function(t){t[t.ArraySeparator=31]="ArraySeparator"}(s||(s={}));const o=t=>{const e=new ArrayBuffer(t.length),n=new Uint8Array(e),i=t.length+1;for(let e=0;e<i;e++)n[e]=t.charCodeAt(e);return e};class a{commandArray=[];setCommand(t,e){if(!t)return this;this.commandArray.push(t);let n=[];return e?(Array.isArray(e)?n=this.convertArray(e):"string"==typeof e&&(n=this.convertStringNumberArray(e)),this.commandArray=[...this.commandArray,...n],this):this}convertStringNumberArray(t){const e=o(t);return Array.from(new Uint8Array(e))}convertArray(t){return t.map((t=>this.convertStringNumberArray(t))).map((t=>(t.push(s.ArraySeparator),t))).flat()}build(){return new Uint8Array(this.commandArray)}}const c=()=>new a;class r{static encode(t,e){const n=new Uint8Array(1);n[0]=i.Payload;const s=t.build(),o=s.byteLength;let a,c=0,r=new Uint8Array(0);e&&(c=e.byteLength+1,r=new Uint8Array(e),a=o+1);const h=new ArrayBuffer(o+c);let l=new Uint8Array(h);return l.set(s,0),e&&(l.set(n,o),l.set(r,a)),l.buffer}static decode(t){const e=t.byteLength,n=new Uint8Array(t);let s=n.indexOf(i.Payload);s=s<0?e:s;const o=n.slice(0,s),a=s+1,c=this.extractCommands(o);return{commands:c,payload:t.slice(a,e),getCommand:t=>!!c[t]&&c[t]}}static hasSeparatorIndexes(t){return t.indexOf(s.ArraySeparator)>0}static commandActionUint8ArrayToString(t){return t.map((t=>String.fromCharCode(t))).join("")}static commandActionUint8ArrayToStringArray(t){const e=[];let n=[];return t.forEach((t=>{t===s.ArraySeparator?(e.push(n),n=[]):n.push(t)})),n.length>0&&e.push(n),e.map((t=>this.commandActionUint8ArrayToString(t.map((t=>Number(t))))))}static extractCommands(t){const e={};let n=null;return t.forEach((t=>{if(Object.values(i).indexOf(t)>=0)return n=t,void(e[n]=[]);e[n].push(t)})),Object.keys(e).forEach((t=>{const n=e[t];this.hasSeparatorIndexes(n)?e[t]=this.commandActionUint8ArrayToStringArray(n):0===n.length?e[t]=!0:e[t]=this.commandActionUint8ArrayToString(n)})),e}}const h=async(t,e,n,s,o,a,h)=>{const l=c().setCommand(i.Topic,e).setCommand(i.Identifier,n).setCommand(i.AddAction),d=r.encode(l,t);return await a.request({baseURL:`${h?.protocol}://${h?.wsHost}`,headers:{"Content-Type":"application/json","X-API-Key":h?.apiKey},url:`/${o}/${s}/publish`,method:"post",data:d}),!0};class l{routeNamespace="Topics";parentRouteNamespace;tunnelId;request;constructor(t,e,n){this.parentRouteNamespace=t,this.tunnelId=e,this.request=n}async createTopic(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,method:"post",data:t})).data}async getTopicById(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"get"})).data}async listTopics(t){const n=t?e(t):"";return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${n}`,method:"get"})).data}async updateTopic(t,e){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"patch",data:e})).data}async deleteTopic(t){return(await this.request.request({url:`/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${t}`,method:"delete"})).data}}class d{connection;topicName;onReceiveCallback;identifiers=[];presence;constructor(t,e,n){this.setConnection(t),this.topicName=e,this.saveIdentifiers(n?.OR??[]),this.subscribe()}findSavedIdentifier(t){const e=Object.keys(t)[0]??"",n=Object.values(t)[0]??"";return this.identifiers.find((t=>{if(t){const i=Object.keys(t)[0]??"",s=Object.values(t)[0]??"";return e===i&&n===s}}))}saveIdentifiers(t){Array.isArray(t)&&t.map((t=>{this.identifiers.find((e=>e===t))||this.identifiers.push(t)}))}deleteSavedIdentifiers(t){const e=[];t.map((t=>{this.identifiers.find((e=>e===t))&&e.push(t)})),this.identifiers=e}subscribe(){if(!this.topicName&&0===this.identifiers?.length||!Array.isArray(this.identifiers))return this;const t=c().setCommand(i.Topic,this.topicName);this.identifiers.length>0&&t.setCommand(i.Identifier,this.identifiers),this.presence&&t.setCommand(i.Presence,this.presence),t.setCommand(i.AddAction);const e=r.encode(t);this.send(e)}setPresence(t){return this.presence=t,this.subscribe(),this}setConnection(t){return this.connection=t,this}_onReceiveMessage(t){return this.onReceiveCallback&&this.onReceiveCallback(t),this}onReceive(t){return this.onReceiveCallback=t,this}addIdentifiers(t){if(!t?.OR?.length||0===t?.OR?.length)return this;const e=t?.OR??[];this.saveIdentifiers(e);const n=c().setCommand(i.Topic,this.topicName);e.length>0&&n.setCommand(i.Identifier,e),n.setCommand(i.AddAction);const s=r.encode(n);return this.send(s),this}removeIdentifiers(t){if(0===t.length)return this;this.deleteSavedIdentifiers(t??[]);const e=c().setCommand(i.Topic,this.topicName);e.setCommand(i.Identifier,t),e.setCommand(i.DeleteAction);const n=r.encode(e);return this.send(n),this}unsubscribe(){const t=c().setCommand(i.Topic,this.topicName).setCommand(i.DeleteAction),e=r.encode(t);return this.send(e),!0}publish(t,e){if(0===t.byteLength)return this;const n=c().setCommand(i.Topic,this.topicName);e?.length>0&&n.setCommand(i.Identifier,e);const s=r.encode(n,t);return this.send(s),this}send(t){this.connection&&this.connection.send(t)}}var u,p,m,C,b,f,v,y;t.EConnectionStatus=void 0,(u=t.EConnectionStatus||(t.EConnectionStatus={})).Idle="idle",u.Connecting="connecting",u.Connected="connected",u.Disconnected="disconnected",t.EEnvironment=void 0,(p=t.EEnvironment||(t.EEnvironment={})).Nodejs="nodejs",p.Browser="browser",t.EAction=void 0,(m=t.EAction||(t.EAction={})).Add="a",m.Delete="d",t.EEncoding=void 0,(t.EEncoding||(t.EEncoding={})).Arraybuffer="arraybuffer",t.EVisibilityState=void 0,(C=t.EVisibilityState||(t.EVisibilityState={})).Hidden="hidden",C.Visible="visible",t.ESeparator=void 0,(b=t.ESeparator||(t.ESeparator={}))[b.Group=29]="Group",b[b.Record=30]="Record",b[b.Unit=31]="Unit",b[b.Vertical=11]="Vertical",b[b.NegativeAck=21]="NegativeAck",b[b.BellAlert=7]="BellAlert",b[b.SynchronousIdle=22]="SynchronousIdle",t.EAccessPermission=void 0,(f=t.EAccessPermission||(t.EAccessPermission={})).Subscribe="subscribe",f.Publish="publish",f.PubSub="pubSub",t.EStatus=void 0,(v=t.EStatus||(t.EStatus={})).Active="active",v.Inactive="inactive",t.ETopicType=void 0,(y=t.ETopicType||(t.ETopicType={})).Standard="standard",y.Api="api";const g={DefaultWsHost:"tunnel.nolag.app",DefaultApiHost:"api.nolag.app",DefaultWsUrl:"/ws",DefaultPort:443,DefaultWsProtocol:"wss",DefaultApiUrl:"/v1",DefaultHttpProtocol:"https"};class I{host;authToken;wsInstance;protocol;url;deviceConnectionId=void 0;environment;deviceTokenId=null;defaultCheckConnectionInterval=100;defaultCheckConnectionTimeout=1e4;checkConnectionInterval;checkConnectionTimeout;reConnect=!1;callbackOnOpen=()=>{};callbackOnReceive=()=>{};callbackOnClose=()=>{};callbackOnError=()=>{};connectionStatus=t.EConnectionStatus.Idle;buffer=[];backpressureSendInterval=0;senderInterval=0;unifiedWebsocket;constructor(t,e,n){this.authToken=e??"",this.host=n?.host??g.DefaultWsHost,this.protocol=n?.protocol??g.DefaultWsProtocol,this.url=g.DefaultWsUrl,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.checkConnectionTimeout=n?.checkConnectionTimeout??this.defaultCheckConnectionTimeout,this.unifiedWebsocket=t,this.startSender()}startSender(){this.senderInterval=setInterval((()=>{const t=this.buffer.shift();t&&this.wsInstance&&this.wsInstance.send&&this.wsInstance.send(t)}),this.backpressureSendInterval)}slowDownSender(t){clearInterval(this.senderInterval),this.backpressureSendInterval=t,this.startSender()}addToBuffer(t){this.buffer.push(t)}setReConnect(t){t&&(this.reConnect=t)}connect(){return this.connectionStatus=t.EConnectionStatus.Idle,this.initWebsocketConnection(),new Promise(((e,n)=>{const i=setInterval((()=>{this.connectionStatus===t.EConnectionStatus.Connected&&(e(this),clearInterval(i))}),this.checkConnectionInterval);setTimeout((()=>{this.connectionStatus===t.EConnectionStatus.Idle&&(n(!0),clearInterval(i))}),this.checkConnectionTimeout)}))}disconnect(){this.wsInstance&&this.wsInstance.close&&(this.wsInstance.close(),this.wsInstance=void 0)}initWebsocketConnection(){this.connectionStatus!==t.EConnectionStatus.Connected&&(this.wsInstance=this.unifiedWebsocket(`${this.protocol}://${this.host}${this.url}`),this.wsInstance&&(this.wsInstance.onOpen=t=>{this._onOpen(t)},this.wsInstance.onMessage=t=>{this._onReceive(t)},this.wsInstance.onClose=t=>{this._onClose(t)},this.wsInstance.onError=t=>{this._onError(t)}))}authenticate(){this.connectionStatus=t.EConnectionStatus.Connecting;const{authToken:e}=this,n=c().setCommand(i.Authenticate,e);this.reConnect&&n.setCommand(i.Reconnect),this.send(r.encode(n))}onOpen(t){this.callbackOnOpen=t}onReceiveMessage(t){this.callbackOnReceive=t}onClose(t){this.callbackOnClose=t}onError(t){this.callbackOnError=t}_onOpen(e){this.connectionStatus,t.EConnectionStatus.Idle,this.callbackOnOpen(void 0,e)}_onReceive(e){const n=e??new ArrayBuffer(0),s=r.decode(n);if(0!==n.byteLength){if(!s.getCommand(i.InitConnection)||this.connectionStatus!==t.EConnectionStatus.Idle)return s.getCommand(i.Acknowledge)&&this.connectionStatus===t.EConnectionStatus.Connecting?(this.connectionStatus=t.EConnectionStatus.Connected,void(this.deviceTokenId=s.getCommand(i.Acknowledge))):s.getCommand(i.Error)?(this.connectionStatus=t.EConnectionStatus.Disconnected,void this.callbackOnError(s.getCommand(i.Alert),void 0)):void this.callbackOnReceive(void 0,{topicName:s.getCommand(i.Topic),presences:s.getCommand(i.Presence),identifiers:s.getCommand(i.Identifier),data:s.payload});this.authenticate()}}_onClose(e){this.connectionStatus=t.EConnectionStatus.Disconnected,this.callbackOnClose(e,void 0)}_onError(e){this.connectionStatus=t.EConnectionStatus.Disconnected,this.callbackOnError(e,void 0)}send(t){this.addToBuffer(t)}heartbeat(){this.wsInstance&&this.send(new ArrayBuffer(0))}}"undefined"!=typeof process&&null!==process.versions&&process.versions.node,console.log(require("./browser"));t.CONSTANT=g,t.NqlTransport=r,t.Topic=d,t.Tunnel=class{noLagClient;connectOptions;authToken;topics={};heartbeatTimer;defaultCheckConnectionInterval=1e4;checkConnectionInterval;heartBeatInterval=2e4;visibilityState=t.EVisibilityState.Visible;callbackOnReceive;callbackOnDisconnect=()=>{};callbackOnReconnect=()=>{};callbackOnReceivedError=()=>{};constructor(t,e,n,i){this.checkConnectionInterval=i?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.connectOptions=i??void 0,this.authToken=e,this.noLagClient=new I(t,this.authToken,this.connectOptions),this.onClose(),this.onError(),this.onReceiveMessage(),n?.disconnectOnNoVisibility&&this.onVisibilityChange()}get deviceTokenId(){return this.noLagClient?.deviceTokenId}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.noLagClient&&this.noLagClient.heartbeat()}),this.heartBeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer)}async initiate(t){return this.noLagClient&&(this.noLagClient.setReConnect(t),await this.noLagClient.connect(),this.startHeartbeat()),this}onVisibilityChange(){document.addEventListener&&document.addEventListener("visibilitychange",(async()=>{switch(this.visibilityState=document.visibilityState,this.visibilityState){case t.EVisibilityState.Hidden:this.noLagClient?.disconnect(),this.stopHeartbeat();break;case t.EVisibilityState.Visible:await this.initiate(!0)}}))}onReceiveMessage(){this.noLagClient&&this.noLagClient?.onReceiveMessage(((t,e)=>{const{topicName:n,identifiers:i}=e;this.noLagClient&&!this.topics[n]&&(this.topics[n]=new d(this.noLagClient,n,{OR:i})),n&&this.topics[n]&&this.topics[n]?._onReceiveMessage(e),"function"==typeof this.callbackOnReceive&&this.callbackOnReceive(e)}))}reconnect(){this.stopHeartbeat(),setTimeout((async()=>{await this.initiate(!0),"function"==typeof this.callbackOnReconnect&&this.callbackOnReconnect()}),this.checkConnectionInterval)}canReconnect(){return this.visibilityState!==t.EVisibilityState.Hidden}doReconnect(){this.canReconnect()?this.reconnect():(this.stopHeartbeat(),"function"==typeof this.callbackOnDisconnect&&this.callbackOnDisconnect("connection retry timeout."))}onClose(){this.noLagClient&&this.noLagClient.onClose(((t,e)=>{this.doReconnect(),"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(t)}))}onError(){this.noLagClient&&this.noLagClient.onError(((t,e)=>{"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(t)}))}onReceive(t){this.callbackOnReceive=t}disconnect(){this.visibilityState=t.EVisibilityState.Hidden,this.noLagClient?.disconnect()}onDisconnect(t){this.callbackOnDisconnect=t}onReconnect(t){this.callbackOnReconnect=t}onErrors(t){this.callbackOnReceivedError=t}getTopic(t){return!this.topics[t]&&this.noLagClient&&(this.topics[t]=new d(this.noLagClient,t,{})),this.topics[t]}unsubscribe(t){return!!this.topics[t]&&(this.topics[t]?.unsubscribe(),delete this.topics[t],!0)}subscribe(t,e={}){if(this.noLagClient)return this.topics[t]||(this.topics[t]=new d(this.noLagClient,t,e)),this.topics[t]}publish(t,e,n=[]){if(this.noLagClient&&this.noLagClient.send){this.stopHeartbeat();const s=c().setCommand(i.Topic,t);n?.length>0&&s.setCommand(i.Identifier,n);const o=r.encode(s,e);this.noLagClient.send(o),this.startHeartbeat()}}get status(){return this.noLagClient?.connectionStatus??null}},t.TunnelApi=class{routeNamespace="tunnels";tunnelId;request;apiTunnel;constructor(t,e,n){this.tunnelId=e,this.request=n,this.apiTunnel=t}get topics(){return new l(this.routeNamespace,this.tunnelId,this.request)}get devices(){return new n(this.routeNamespace,this.tunnelId,this.request)}async publish(t){const{data:e,topicName:n,identifiers:i}=t;return h(e,n,i,this.tunnelId,this.routeNamespace,this.request,this.apiTunnel.connectOptions)}},t.TunnelDevice=n,t.TunnelPublish=h,t.TunnelTopic=l,t.generateQueryString=e,t.stringToArrayBuffer=o,t.test="test",t.uint8ArrayToString=t=>new Uint8Array(t).reduce(((t,e)=>t+String.fromCharCode(e)),"")}));
//# sourceMappingURL=index.js.map
